<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAR Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css', v=version) }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    {% if ga_id %}
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ ga_id }}"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', '{{ ga_id }}');
    </script>
    {% endif %}
</head>
<body>
    <div class="container">
        <header class="main-header">
            <h1>HAR Analyzer</h1>
            <p>Upload a .HAR file to analyze network requests.</p>
        </header>

        <form id="upload-form" class="controls-grid">
            <div class="card file-upload-card">
                <h2>Upload File</h2>
                <div id="drop-zone">
                    <input type="file" id="har-file" name="har_file" accept=".har" required>
                    <p>Drag & drop a .HAR file here, or click to select.</p>
                </div>
                <div id="file-info" class="file-info-hidden">
                    Selected file: <span id="file-name"></span>
                </div>
            </div>

            <div class="card options-card">
                <div class="options-header">
                    <h2>Options</h2>
                    <button type="button" id="clear-filters-btn" class="secondary-button">Clear Filters</button>
                </div>
                <div class="options-grid">
                    <!-- Filtering -->
                    <fieldset>
                        <legend>Filter by Error</legend>
                        <select name="error-filter" id="error-filter">
                            <option value="">All Requests</option>
                            <option value="no-errors">No Errors</option>
                            <option value="has-errors">With Errors</option>
                        </select>
                    </fieldset>
                    <fieldset>
                        <legend>Filter by Method</legend>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="method" value="GET"> GET</label>
                            <label><input type="checkbox" name="method" value="POST"> POST</label>
                            <label><input type="checkbox" name="method" value="PUT"> PUT</label>
                            <label><input type="checkbox" name="method" value="DELETE"> DELETE</label>
                            <label><input type="checkbox" name="method" value="OPTIONS"> OPTIONS</label>
                        </div>
                    </fieldset>
                     <fieldset>
                        <legend>Filter by Content Type</legend>
                         <div class="checkbox-group">
                            <label><input type="checkbox" name="content-type" value="json"> JSON</label>
                            <label><input type="checkbox" name="content-type" value="javascript"> JS</label>
                            <label><input type="checkbox" name="content-type" value="css"> CSS</label>
                            <label><input type="checkbox" name="content-type" value="image"> Image</label>
                            <label><input type="checkbox" name="content-type" value="html"> HTML</label>
                        </div>
                    </fieldset>
                    <fieldset>
                        <legend>Filter by URL</legend>
                        <input type="text" name="url-contains" id="url-contains" placeholder="e.g., /api/v1">
                    </fieldset>
                    <fieldset>
                        <legend>URL Length Limit</legend>
                        <input type="number" name="max-url-len" id="max-url-len" placeholder="e.g., 250" min="0">
                    </fieldset>
                    <fieldset>
                        <legend>Group By</legend>
                        <select name="group-by" id="group-by">
                            <option value="">None</option>
                            <option value="method">Method</option>
                            <option value="content-type">Content Type</option>
                            <option value="status">Status Code</option>
                            <option value="domain">Domain</option>
                        </select>
                    </fieldset>
                    <fieldset class="full-width">
                        <legend>Search in Response Body</legend>
                        <div class="input-with-checkbox">
                            <input type="text" name="content-contains" id="content-contains" placeholder="e.g., user_id">
                            <label class="regex-label" title="Use regular expressions for advanced searching">
                                <input type="checkbox" name="content-regex" id="content-regex" value="true">
                                Regex
                            </label>
                        </div>
                    </fieldset>
                    <!-- Domain Filter -->
                    <fieldset id="domain-filter-fieldset" class="hidden full-width">
                        <legend>Filter by Domain</legend>
                        <div class="multiselect">
                            <div class="select-box" id="domain-select-box">
                                <span class="select-text">Select domains</span>
                                <span class="select-arrow">&#9662;</span>
                            </div>
                            <div id="domain-checkboxes" class="hidden">
                                <!-- Checkboxes will be dynamically inserted here -->
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>

            <button type="submit" class="analyze-button">Analyze</button>
        </form>

        <section id="results-section" class="results-hidden">
            <div class="results-header">
                <h2>Analysis Results</h2>
                <button id="download-har-btn" class="hidden">Download Filtered .HAR</button>
            </div>
            <div id="spinner" class="spinner-hidden"></div>
            <div id="results-container"></div>
        </section>

    </div>
    <script src="{{ url_for('static', filename='script.js', v=version) }}"></script>

    <div id="modal" class="modal-hidden">
        <div id="modal-overlay"></div>
        <div id="modal-content">
            <div class="modal-header">
                <h2>Request Details</h2>
                <div class="modal-actions">
                    <button id="copy-curl-btn">Copy as cURL</button>
                    <button id="modal-close-btn">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="modal-tabs">
                    <div>
                        <button class="modal-tab-btn active" data-tab="general">General</button>
                        <button class="modal-tab-btn" data-tab="headers">Headers</button>
                        <button class="modal-tab-btn" data-tab="response">Response</button>
                        <button class="modal-tab-btn" data-tab="preview">Preview</button>
                        <button class="modal-tab-btn" data-tab="timings">Timings</button>
                    </div>
                    <button id="download-response-btn">Download Response</button>
                </div>
                <div class="modal-tab-content">
                    <div class="modal-tab-pane active" data-tab-content="general"></div>
                    <div class="modal-tab-pane" data-tab-content="headers"></div>
                    <div class="modal-tab-pane" data-tab-content="response">
                        <pre id="response-content-pre"></pre>
                    </div>
                    <div class="modal-tab-pane" data-tab-content="preview"></div>
                    <div class="modal-tab-pane" data-tab-content="timings"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="download-options-modal" class="modal-hidden">
        <div id="modal-overlay"></div>
        <div id="modal-content">
            <div class="modal-header">
                <h2>Download Options</h2>
                <button id="download-options-close-btn" class="modal-close-button">&times;</button>
            </div>
            <div class="modal-body">
                <p>Some requests were grouped. Choose how many instances to include in the downloaded .HAR file.</p>
                <div class="download-options-global-actions">
                    <span>Apply to all:</span>
                    <button type="button" class="secondary-button" data-action="all">Include All</button>
                    <button type="button" class="secondary-button" data-action="first">Include First</button>
                    <button type="button" class="secondary-button" data-action="manual">Select Manually</button>
                </div>
                <div id="download-options-list"></div>
            </div>
            <div class="modal-footer">
                <button id="download-confirm-btn" class="analyze-button">Download</button>
            </div>
        </div>
    </div>
</body>
</html>
